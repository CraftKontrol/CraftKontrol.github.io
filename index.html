<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKUI Support - TouchDesigner Troubleshooting Assistant</title>
    <style>
        :root {
            --primary-color: #0088ff;
            --primary-dark: #0066cc;
            --secondary-color: #1a1a2e;
            --background-color: #0f0f1a;
            --surface-color: #16213e;
            --text-color: #e8e8e8;
            --text-muted: #888;
            --border-color: #2a2a4a;
            --error-color: #ff4444;
            --success-color: #44ff88;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--background-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--surface-color);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .header-title {
            flex: 1;
        }

        .header-title h1 {
            font-size: 1.4rem;
            color: var(--text-color);
        }

        .header-title p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* API Key Section */
        .api-key-section {
            background: var(--surface-color);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .api-key-section label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .api-key-section input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--background-color);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .api-key-section input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .api-key-section .hint {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .api-key-section a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .api-key-section a:hover {
            text-decoration: underline;
        }

        /* Main Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: var(--primary-color);
        }

        .message.user .message-avatar {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
        }

        .message-content {
            background: var(--surface-color);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: var(--primary-color);
        }

        .message-content p {
            margin-bottom: 0.5rem;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.75rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content ul,
        .message-content ol {
            margin-left: 1.2rem;
            margin-bottom: 0.5rem;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 0.5rem;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* Input Area */
        .input-container {
            padding: 1rem;
            background: var(--surface-color);
            border-radius: 12px;
            margin-top: auto;
        }

        .input-wrapper {
            display: flex;
            gap: 0.75rem;
        }

        .input-wrapper textarea {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--background-color);
            color: var(--text-color);
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 48px;
            max-height: 150px;
        }

        .input-wrapper textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .input-wrapper textarea::placeholder {
            color: var(--text-muted);
        }

        .send-button {
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .send-button:hover {
            background: var(--primary-dark);
        }

        .send-button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .welcome-message h2 {
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .welcome-message p {
            margin-bottom: 1rem;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .quick-action {
            padding: 0.5rem 1rem;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .quick-action:hover {
            border-color: var(--primary-color);
            background: rgba(0, 136, 255, 0.1);
        }

        /* Error Message */
        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid var(--error-color);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            color: var(--error-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
            }

            .api-key-section {
                padding: 0.75rem 1rem;
                flex-direction: column;
                align-items: stretch;
            }

            .chat-container {
                padding: 0.5rem;
            }

            .message {
                max-width: 95%;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">CK</div>
        <div class="header-title">
            <h1>CKUI Support Assistant</h1>
            <p>TouchDesigner Troubleshooting Chatbot</p>
        </div>
    </header>

    <div class="api-key-section">
        <label for="apiKey">Mistral API Key:</label>
        <input type="password" id="apiKey" placeholder="Enter your Mistral API key..." />
        <span class="hint">
            Get your API key from <a href="https://console.mistral.ai/" target="_blank" rel="noopener noreferrer">Mistral AI Console</a>
        </span>
    </div>

    <main class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message" id="welcomeMessage">
                <h2>ðŸ‘‹ Welcome to CKUI Support</h2>
                <p>I'm here to help you troubleshoot CKUI modules for TouchDesigner.</p>
                <p>Ask me about Project Manager, library setup, configurations, and more!</p>
                <div class="quick-actions">
                    <button class="quick-action" onclick="askQuestion('How do I set up the Project Manager?')">Set up Project Manager</button>
                    <button class="quick-action" onclick="askQuestion('How do I configure libraries?')">Configure Libraries</button>
                    <button class="quick-action" onclick="askQuestion('How do I create a virtual environment?')">Create Virtual Environment</button>
                    <button class="quick-action" onclick="askQuestion('What are the CKUI dependencies?')">CKUI Dependencies</button>
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    id="userInput" 
                    placeholder="Ask about CKUI modules, TouchDesigner setup, troubleshooting..." 
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                ></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    Send
                </button>
            </div>
        </div>
    </main>

    <script>
        // CKUI Knowledge Base - Context for the chatbot
        const CKUI_CONTEXT = `
You are a helpful assistant specialized in CKUI (CraftKontrol UI) modules for TouchDesigner. 
You help users troubleshoot and understand the CKUI System.

CKUI System Overview:
- CKUI is a user interface framework designed for interactive installations and applications in TouchDesigner
- It is part of the CKLib library, providing tools for building interactive experiences
- Author: Arnaud Cassone Â© Artcraft Visuals

Project Manager Module (Version 1.03):
The Project Manager is a TouchDesigner project configurator tool that helps manage project dependencies, configurations, and repositories.

Key Features:
1. Project Location Management:
   - Checks for saved project location
   - Opens popup to set project location if not found

2. Logger Integration:
   - Checks for Logger installation paths
   - Sets Logger path if not found
   - Supports WebLogger module for remote logging

3. Configuration Management:
   - Checks for config.json file
   - Creates config.json with project settings including:
     * Project name
     * Tools path
     * Log path
     * TouchDesigner version
     * Modules and Properties

4. Git Integration:
   - Checks for .gitignore file (creates if not found)
   - Checks for git installation
   - Installs GitPython if not found
   - Can clone required libraries on demand

5. Network Information:
   - Shows IP addresses for local network access

6. Library Management:
   - Checks for libraries folder
   - Supports downloading these libraries:
     * CKUI - Main UI framework
     * TD-Library (CKTDLibrary) - TouchDesigner utilities
     * GroundGen - Ground generation tools
     * Terrain-Tools - Terrain manipulation tools

7. Virtual Environment (venv) Support:
   - Can create Python virtual environments
   - Supports multiple Python versions
   - Manages pip package installation

Parameters Reference:
| Parameter | Type | Description |
|----------------------|------|---------------------------------|
| Info | Str | General information display |
| Manualsetup | Pulse | Trigger manual setup |
| Logger | Str | Logger status |
| Systeminfos | Header | System information section |
| Ipaddress1/2 | Str | Local IP addresses |
| Librariesheader | Header | Libraries section |
| Libraries | Folder | Libraries folder path |
| Ckui | Str | CKUI library status |
| Downloadckui | Pulse | Download CKUI library |
| Ggen | Str | GroundGen library status |
| Downloadggen | Pulse | Download GroundGen |
| Terrain | Str | Terrain Tools status |
| Downloadterrain | Pulse | Download Terrain Tools |
| Baseversion | Str | Base Python version |
| Installpython | Pulse | Install Python |
| Pythonversion | Str | Python version info |
| Venv | Header | Virtual environment section |
| Status | Str | Venv status |
| Createvenv | Pulse | Create virtual environment |
| Version | Menu | Python version selection |
| Venvfolder | Folder | Venv folder path |
| Pip | Header | Pip section |
| Pipinstallpackage | Pulse | Install pip package |
| Package | Str | Package name to install |
| Cktdlibrary | Str | CK TD Library status |
| Downloadcktd | Pulse | Download CK TD Library |

Common Troubleshooting:

1. Virtual Environment Issues:
   - Check if venv folder exists
   - Verify Python executable path
   - Ensure pip is installed in venv

2. Library Not Found:
   - Check Libraries folder path is correct
   - Use Download buttons to clone from GitHub
   - Verify Git is installed

3. Logger Issues:
   - Check Logger path is set correctly
   - Verify log folder exists
   - Enable Active and Logtofile parameters

4. Config Issues:
   - Delete config.json to regenerate
   - Check project folder permissions
   - Verify JSON structure is valid

5. Git/Cloning Issues:
   - Ensure GitPython is installed
   - Check internet connection
   - Verify repository URLs are accessible

Repository URLs:
- CKUI: https://github.com/CraftKontrol/CKUI.git
- GroundGen: https://github.com/CraftKontrol/GroundGen-for-Touchdesigner.git
- Terrain Tools: https://github.com/CraftKontrol/Terrain-Tools-for-Touchdesigner.git
- TD-Library: https://github.com/CraftKontrol/TD-Library.git

When answering questions:
- Be concise but thorough
- Provide step-by-step instructions when appropriate
- Reference specific parameters or functions when relevant
- Suggest checking the Logger for error messages
- Recommend using the Project Manager's built-in features
`;

        let conversationHistory = [];
        let isLoading = false;

        // Auto-resize textarea
        const textarea = document.getElementById('userInput');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Load API key from sessionStorage (more secure than localStorage for sensitive data)
        const apiKeyInput = document.getElementById('apiKey');
        const savedApiKey = sessionStorage.getItem('mistralApiKey');
        if (savedApiKey) {
            apiKeyInput.value = savedApiKey;
        }

        // Save API key to sessionStorage when changed (clears when browser tab is closed)
        apiKeyInput.addEventListener('change', function() {
            sessionStorage.setItem('mistralApiKey', this.value);
        });

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function askQuestion(question) {
            document.getElementById('userInput').value = question;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!message || isLoading) return;

            if (!apiKey) {
                showError('Please enter your Mistral API key to use the chatbot.');
                return;
            }

            // Hide welcome message
            const welcomeMsg = document.getElementById('welcomeMessage');
            if (welcomeMsg) {
                welcomeMsg.style.display = 'none';
            }

            // Add user message to UI
            addMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';

            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: message
            });

            // Show typing indicator
            showTypingIndicator();
            isLoading = true;
            document.getElementById('sendButton').disabled = true;

            try {
                const response = await callMistralAPI(apiKey, message);
                hideTypingIndicator();
                
                // Add assistant message to UI
                addMessage(response, 'assistant');
                
                // Add to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: response
                });
            } catch (error) {
                hideTypingIndicator();
                showError(error.message);
            } finally {
                isLoading = false;
                document.getElementById('sendButton').disabled = false;
            }
        }

        async function callMistralAPI(apiKey, userMessage) {
            const messages = [
                {
                    role: 'system',
                    content: CKUI_CONTEXT
                },
                ...conversationHistory
            ];

            const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'mistral-small-latest',
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 1024
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                if (response.status === 401) {
                    throw new Error('Invalid API key. Please check your Mistral API key.');
                } else if (response.status === 429) {
                    throw new Error('Rate limit exceeded. Please wait a moment and try again.');
                } else {
                    throw new Error(errorData.message || `API error: ${response.status}`);
                }
            }

            const data = await response.json();
            
            // Validate API response structure
            if (!data || !data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {
                throw new Error('Invalid response from API. Please try again.');
            }
            
            return data.choices[0].message.content;
        }

        function addMessage(content, role) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(content);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatMessage(content) {
            // First escape HTML to prevent XSS
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            // Escape the content first
            let formatted = escapeHtml(content);
            
            // Then apply safe markdown-style formatting
            formatted = formatted
                // Code blocks (already escaped, safe to wrap in tags)
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Bold
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                // Line breaks
                .replace(/\n/g, '<br>');

            return formatted;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ðŸ¤–';

            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';

            typingDiv.appendChild(avatar);
            typingDiv.appendChild(indicator);
            chatMessages.appendChild(typingDiv);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function showError(message) {
            const chatMessages = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>
